Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_EPI_Epilogue_EmperorRootLetters((ITEMROOT)S_EPI_Epilogue_Letter_EmperorWasPartneredKarlach_44e9b9ac-f40e-4b64-b61e-c05ebd3488bd);
DB_EPI_Epilogue_EmperorRootLetters((ITEMROOT)S_EPI_Epilogue_Letter_EmperorWasPartnered_75cd9117-a7e5-4ad2-895e-d3367cfcb0e5);
DB_EPI_Epilogue_EmperorRootLetters((ITEMROOT)S_EPI_Epilogue_Letter_EmperorWasPartneredMF_e53dd98a-0037-4871-8093-e94270dd2e97);
KBSECTION
//REGION US SETUP
PROC
PROC_EPI_Epilogue_SetCharacters()
AND
DB_GlobalFlag((FLAG)EPI_Us_State_Kept_d7751cd6-1b02-f874-af94-c163a862e52c)
AND
DB_GlobalFlag((FLAG)EPI_Epilogue_State_EmperorRomanceContinued_8d6a5e8a-f639-fd9b-250a-12ff6cd3c87c)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)ORI_State_PartneredWithEmperor_19ee118a-7edb-d8b7-2191-d9aae4451222, _Player, 1)
AND
CreateAtObject((CHARACTERROOT)Intellect_Devourer_PlayerWildshape_27b9089b-9aef-44e9-aaf7-100e3e320823, (TRIGGER)S_EPI_StartPointShadowheart_18c42a94-a57a-4a55-9d7c-dd67a49d8bbb, 0, 0, "", 1, _SpawnedUs)
THEN
PROC_SetAnubisConfig((CHARACTER)_SpawnedUs, "EPI_Us");
ObjectSetTitle(_SpawnedUs, "EPI_Title_Us");
SetFaction(_SpawnedUs, (FACTION)ACT3_EPI_Us_5f63b61f-60d3-4839-b379-9f09f32ef107);
DB_Dialogs(_SpawnedUs,(DIALOGRESOURCE)EPI_Epilogue_Us_6bacf635-b7d4-5286-e236-2025f27cf795);
DB_Epilogue_Us(_SpawnedUs);
PROC_SetUsStatus();

PROC
PROC_SetUsStatus()
AND
DB_Epilogue_Us(_Us)
AND
DB_GlobalFlag((FLAG)TUT_Lab_State_LobotomizedBrain_d303b55f-b9b1-4acc-b052-26622a337867)
THEN
ApplyStatus(_Us,"LOBOTOMIZED_US",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SetUsStatus()
AND
DB_Epilogue_Us(_Us)
AND
NOT DB_GlobalFlag((FLAG)TUT_Lab_State_LobotomizedBrain_d303b55f-b9b1-4acc-b052-26622a337867)
THEN
ApplyStatus(_Us,"NORMAL_US",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION LETTER SETUP
PROC
PROC_EPI_Epilogue_SetupLetters()
AND
DB_EPI_Epilogue_EmperorRootLetters(_ItemRoot)
AND
QRY_EPI_Epilogue_EmperorRootLetterIsValid((ITEMROOT) _ItemRoot)
AND
QRY_OnlyOnce("EPI_Letter_Emperor_Picked")
THEN
TemplateAddTo(_ItemRoot, S_EPI_Letterbox_a8c7f035-7564-46fe-88ac-a70faabdd7c0, 1, 0);

IF
FlagSet((FLAG)EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e, _, _)
AND
IsInInventoryOf((ITEM)S_EPI_Letter_EmperorBigPlans_f5304063-f97b-4076-809a-ecfc323eea40, S_EPI_Letterbox_a8c7f035-7564-46fe-88ac-a70faabdd7c0, 1)
THEN
ToInventory(S_EPI_Letter_EmperorBigPlans_f5304063-f97b-4076-809a-ecfc323eea40, S_EPI_ChestOfGearBanishment_fe6caedc-1122-4041-aec7-d8cc1b1fa49e, 1, 0, 1);

IF
FlagSet((FLAG)EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e, _, _)
AND
IsInInventoryOf((ITEM)S_EPI_Letter_EmperorAllies_9c3e2dfb-d399-4c44-ade8-db6181d92700, S_EPI_Letterbox_a8c7f035-7564-46fe-88ac-a70faabdd7c0, 1)
THEN
ToInventory(S_EPI_Letter_EmperorAllies_9c3e2dfb-d399-4c44-ade8-db6181d92700, S_EPI_ChestOfGearBanishment_fe6caedc-1122-4041-aec7-d8cc1b1fa49e, 1, 0, 1);

IF
FlagSet((FLAG)EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e, _, _)
AND
IsInInventoryOf((ITEM)S_EPI_Letter_EmperorPlayerMF_646bc376-97dc-420c-8804-318c29b73e47, S_EPI_Letterbox_a8c7f035-7564-46fe-88ac-a70faabdd7c0, 1)
THEN
ToInventory(S_EPI_Letter_EmperorPlayerMF_646bc376-97dc-420c-8804-318c29b73e47, S_EPI_ChestOfGearBanishment_fe6caedc-1122-4041-aec7-d8cc1b1fa49e, 1, 0, 1);

IF
FlagSet((FLAG)EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e, _, _)
AND
IsInInventoryOf((ITEM)S_EPI_Letter_Emperor_9eecd32e-ade2-4397-ac3e-cdc9f091e05e, S_EPI_Letterbox_a8c7f035-7564-46fe-88ac-a70faabdd7c0, 1)
THEN
ToInventory(S_EPI_Letter_Emperor_9eecd32e-ade2-4397-ac3e-cdc9f091e05e, S_EPI_ChestOfGearBanishment_fe6caedc-1122-4041-aec7-d8cc1b1fa49e, 1, 0, 1);

QRY
QRY_EPI_Epilogue_EmperorRootLetterIsValid((ITEMROOT)S_EPI_Epilogue_Letter_EmperorWasPartneredKarlach_44e9b9ac-f40e-4b64-b61e-c05ebd3488bd)
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
GetFlag((FLAG)EPI_State_WasPartneredWithEmperor_9ce954e4-dcdc-fed0-4dce-f051a52f3ee9, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1)
AND
DB_GlobalFlag(EPI_Epilogue_State_EmperorWasPartnered_138bd4c9-3fb8-af68-fad3-791098e9baf2)
AND
DB_GlobalFlag(ORI_Karlach_State_AvernusAlone_c5ffd6ad-7749-6eb8-992e-48d66766f6b6)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_EmperorRootLetterIsValid((ITEMROOT)S_EPI_Epilogue_Letter_EmperorWasPartnered_75cd9117-a7e5-4ad2-895e-d3367cfcb0e5)
AND
DB_GlobalFlag(EPI_Epilogue_State_EmperorWasPartnered_138bd4c9-3fb8-af68-fad3-791098e9baf2)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)EPI_State_WasPartneredWithEmperor_9ce954e4-dcdc-fed0-4dce-f051a52f3ee9, _Player, 1)
AND
HasActiveStatus(_Player, "MIND_FLAYER_FORM", 0)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_EmperorRootLetterIsValid((ITEMROOT)S_EPI_Epilogue_Letter_EmperorWasPartneredMF_e53dd98a-0037-4871-8093-e94270dd2e97)
AND
DB_GlobalFlag(EPI_Epilogue_State_EmperorWasPartnered_138bd4c9-3fb8-af68-fad3-791098e9baf2)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)EPI_State_WasPartneredWithEmperor_9ce954e4-dcdc-fed0-4dce-f051a52f3ee9, _Player, 1)
AND
HasActiveStatus(_Player, "MIND_FLAYER_FORM", 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION NESTED DIALOG TELEPORT

IF
FlagSet((FLAG)EPI_Epilogue_State_EmperorHadSecludedDialog_724421f0-c181-bed0-e459-9bdfeeb5d4d5, _, _)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)ORI_State_PartneredWithEmperor_19ee118a-7edb-d8b7-2191-d9aae4451222, _Player, 1)
THEN
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_EPI_Owlbear_FireflySpot_39ee94dd-f1e4-421c-8107-adc6bfe069ad);
TeleportTo(_Player, TimelineSceneTrigger_FestivityBeach_A_e1408b68-0fa2-480c-a64f-8d91a25ea74a);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3c_EPI"
